# Task Management API Documentation

## Overview

The Task Management API is a RESTful service for creating, reading, updating, and deleting tasks, as well as managing users and roles. It uses MongoDB as its persistent data storage and is built with Go and the Gin web framework. The API supports JWT-based authentication and role-based access control (admin, user).

---

## Table of Contents

1. [Getting Started](#getting-started)
2. [MongoDB Configuration](#mongodb-configuration)
3. [User Model](#user-model)
4. [Task Model](#task-model)
5. [API Endpoints](#api-endpoints)
    - [POST /register](#post-register)
    - [POST /login](#post-login)
    - [POST /users/:id/promote](#post-usersidpromote)
    - [GET /tasks](#get-tasks)
    - [GET /tasks/:id](#get-tasksid)
    - [POST /tasks](#post-tasks)
    - [PUT /tasks/:id](#put-tasksid)
    - [DELETE /tasks/:id](#delete-tasksid)
6. [Authentication & Authorization](#authentication--authorization)
7. [Error Handling](#error-handling)
8. [How the API Interacts with MongoDB](#how-the-api-interacts-with-mongodb)
9. [Example Usage](#example-usage)
10. [Troubleshooting](#troubleshooting)

---

## Getting Started

### Prerequisites

- Go 1.18 or later
- MongoDB (local or remote instance)
- (Optional) [MongoDB Compass](https://www.mongodb.com/products/compass) for GUI access

### Installation & Setup

1. **Clone the repository** and navigate to the project directory.
2. **Install dependencies** (if not already done):
   ```sh
   go mod tidy
   ```
3. **Configure MongoDB connection** (optional):
   - By default, the API connects to `mongodb://localhost:27017`.
   - To use a different MongoDB instance, set the `MONGODB_URI` environment variable:
     - **Linux/macOS:**
       ```sh
       export MONGODB_URI="mongodb://your-mongodb-host:27017"
       ```
     - **Windows PowerShell:**
       ```powershell
       $env:MONGODB_URI="mongodb://your-mongodb-host:27017"
       ```
4. **JWT Secret (Development Only):**
   - The JWT secret key is hardcoded in the code as `your_dev_secret_key` for development and testing purposes.
   - **Warning:** This is NOT secure for production. In production, use a secure secret management approach.
5. **Start the API server:**
   ```sh
   go run main.go
   ```
   The server will run on `http://localhost:8080`.

---

## MongoDB Configuration

- **Database:** `taskdb`
- **Collections:** `users`, `tasks`
- The API will automatically create the database and collections if they do not exist.

---

## User Model

Users are stored in MongoDB with the following structure:

```json
{
  "id": "ObjectID (string, generated by MongoDB)",
  "username": "unique username",
  "password": "hashed password",
  "role": "admin | user"
}
```
- The `role` field determines access rights. The first registered user is always an `admin`.

---

## Task Model

Tasks are stored in MongoDB with the following structure:

```json
{
  "id": "ObjectID (string, generated by MongoDB)",
  "title": "Task Title",
  "description": "Task Description",
  "due_date": "YYYY-MM-DD",
  "status": "pending | completed | ... (string)"
}
```

---

## API Endpoints

### POST /register
- **Description:** Register a new user. The first user is assigned the `admin` role; others are `user` by default.
- **Request Body:**
```json
{
  "username": "unique_username",
  "password": "your_password"
}
```
- **Response:**
  - `201 Created` with the created user (without password)
  - `400 Bad Request` if the username is taken or invalid

---

### POST /login
- **Description:** Authenticate a user and receive a JWT access token.
- **Request Body:**
```json
{
  "username": "your_username",
  "password": "your_password"
}
```
- **Response:**
  - `200 OK` with user info and JWT token
  - `401 Unauthorized` if credentials are invalid

---

### POST /users/:id/promote
- **Description:** Promote a user to admin. **Admin only.**
- **Authentication:** Requires JWT token with `admin` role.
- **Parameters:**
  - `id` (string, required): The ObjectID of the user to promote.
- **Response:**
  - `200 OK` with the updated user (without password)
  - `400 Bad Request` or `404 Not Found` on error

---

### GET /tasks
- **Description:** Retrieve a list of all tasks.
- **Authentication:** Requires JWT token (any user).
- **Response:**
  - `200 OK` with array of tasks

---

### GET /tasks/:id
- **Description:** Retrieve a specific task by its MongoDB ObjectID.
- **Authentication:** Requires JWT token (any user).
- **Parameters:**
  - `id` (string, required): The ObjectID of the task.
- **Response:**
  - `200 OK` with task object
  - `404 Not Found` or `400 Bad Request` on error

---

### POST /tasks
- **Description:** Create a new task. **Admin only.**
- **Authentication:** Requires JWT token with `admin` role.
- **Request Body:**
```json
{
  "title": "Task Title",
  "description": "Task Description",
  "due_date": "2024-06-01",
  "status": "pending"
}
```
- **Response:**
  - `201 Created` with the created task
  - `400 Bad Request` on error

---

### PUT /tasks/:id
- **Description:** Update an existing task by its ObjectID. **Admin only.**
- **Authentication:** Requires JWT token with `admin` role.
- **Parameters:**
  - `id` (string, required): The ObjectID of the task.
- **Request Body:**
```json
{
  "title": "Updated Title",
  "description": "Updated Description",
  "due_date": "2024-06-02",
  "status": "completed"
}
```
- **Response:**
  - `200 OK` with the updated task
  - `400 Bad Request` or `404 Not Found` on error

---

### DELETE /tasks/:id
- **Description:** Delete a task by its ObjectID. **Admin only.**
- **Authentication:** Requires JWT token with `admin` role.
- **Parameters:**
  - `id` (string, required): The ObjectID of the task.
- **Response:**
  - `204 No Content` on success
  - `404 Not Found` or `400 Bad Request` on error

---

## Authentication & Authorization

- **JWT Authentication:**
  - Obtain a JWT token by logging in (`/login`).
  - Include the token in the `Authorization` header for all protected endpoints:
    ```http
    Authorization: Bearer <your_jwt_token>
    ```
- **User Roles:**
  - `admin`: Can create, update, delete tasks, and promote users.
  - `user`: Can only view tasks.
- **First User:**
  - The first registered user is always an admin.
- **Promote Endpoint:**
  - Only admins can promote other users to admin via `/users/:id/promote`.
- **JWT Secret (Development Only):**
  - The JWT secret key is hardcoded in the code as `your_dev_secret_key` for development and testing purposes.
  - **Warning:** This is NOT secure for production. In production, use a secure secret management approach.

---

## Error Handling

- All errors are returned as JSON objects:
```json
{
  "error": "Error message"
}
```
- Common error codes:
  - `400 Bad Request`: Invalid input or ID format
  - `401 Unauthorized`: Missing or invalid JWT token
  - `403 Forbidden`: Insufficient permissions (e.g., non-admin trying to access admin-only endpoint)
  - `404 Not Found`: Resource not found
  - `500 Internal Server Error`: Database or server error

---

## How the API Interacts with MongoDB

- **Create:** Inserts a new document into the `users` or `tasks` collection.
- **Read:** Queries the `users` or `tasks` collection by ObjectID or fetches all documents.
- **Update:** Updates fields of a document by ObjectID.
- **Delete:** Removes a document by ObjectID.
- All operations use context timeouts for reliability and proper resource management.

---

## Example Usage

**Register a User:**
```sh
curl -X POST http://localhost:8080/register \
  -H "Content-Type: application/json" \
  -d '{"username":"adminuser","password":"adminpass"}'
```

**Login and Get JWT Token:**
```sh
curl -X POST http://localhost:8080/login \
  -H "Content-Type: application/json" \
  -d '{"username":"adminuser","password":"adminpass"}'
```

**Use JWT Token to Access Protected Endpoint:**
```sh
curl http://localhost:8080/tasks \
  -H "Authorization: Bearer <your_jwt_token>"
```

**Promote a User to Admin:**
```sh
curl -X POST http://localhost:8080/users/<user_id>/promote \
  -H "Authorization: Bearer <admin_jwt_token>"
```

**Create a Task (Admin Only):**
```sh
curl -X POST http://localhost:8080/tasks \
  -H "Authorization: Bearer <admin_jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{"title":"Task Title","description":"Task Description","due_date":"2024-06-10","status":"pending"}'
```

---

## Troubleshooting

- **MongoDB Connection Issues:**  
  Ensure MongoDB is running and accessible at the URI specified by `MONGODB_URI`.
- **JWT Issues:**  
  The JWT secret key is hardcoded for development. If you change it in the code, all tokens must be reissued.
- **Invalid ObjectID:**  
  Use the `id` returned by the API for all operations requiring an ID.
- **Data Not Persisting:**  
  Check MongoDB logs and ensure the correct database/collection is being used.

---

If you have further questions or need help, please refer to the codebase or contact the maintainer.
